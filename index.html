<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Availability Schedule</title>
  <style>
    /* ── Tokens ────────────────────────────────────── */
    :root {
      --bg:              #f8f9fa;
      --bg-secondary:    #ffffff;
      --card:            #ffffff;
      --text-primary:    #1a1a2e;
      --text-secondary:  #64748b;
      --text-tertiary:   #94a3b8;
      --accent:          #6366f1;
      --accent-light:    rgba(99, 102, 241, 0.08);
      --accent-glow:     rgba(99, 102, 241, 0.15);
      --today-col:       rgba(99, 102, 241, 0.04);
      --today-border:    rgba(99, 102, 241, 0.2);
      --busy-bg:         linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
      --busy-border:     #f87171;
      --busy-text:       #991b1b;
      --free-bg:         #ffffff;
      --free-border:     #e2e8f0;
      --grid-line:       rgba(0, 0, 0, 0.06);
      --shadow-sm:       0 1px 2px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.03);
      --shadow-md:       0 4px 6px rgba(0,0,0,0.04), 0 10px 40px rgba(0,0,0,0.06);
      --shadow-glow:     0 0 0 3px var(--accent-glow);
      --radius-xl:       24px;
      --radius-lg:       16px;
      --radius-md:       12px;
      --radius-sm:       8px;
      --transition:      0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Dark mode */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg:              #0f0f1a;
        --bg-secondary:    #1a1a2e;
        --card:            #1e1e32;
        --text-primary:    #f1f5f9;
        --text-secondary:  #94a3b8;
        --text-tertiary:   #64748b;
        --accent:          #818cf8;
        --accent-light:    rgba(129, 140, 248, 0.12);
        --accent-glow:     rgba(129, 140, 248, 0.2);
        --today-col:       rgba(129, 140, 248, 0.08);
        --today-border:    rgba(129, 140, 248, 0.3);
        --busy-bg:         linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
        --busy-border:     #dc2626;
        --busy-text:       #fecaca;
        --free-bg:         #1e1e32;
        --free-border:     rgba(255, 255, 255, 0.12);
        --grid-line:       rgba(255, 255, 255, 0.06);
        --shadow-sm:       0 1px 2px rgba(0,0,0,0.2), 0 4px 12px rgba(0,0,0,0.15);
        --shadow-md:       0 4px 6px rgba(0,0,0,0.2), 0 10px 40px rgba(0,0,0,0.25);
      }
    }

    [data-theme="dark"] {
      --bg:              #0f0f1a;
      --bg-secondary:    #1a1a2e;
      --card:            #1e1e32;
      --text-primary:    #f1f5f9;
      --text-secondary:  #94a3b8;
      --text-tertiary:   #64748b;
      --accent:          #818cf8;
      --accent-light:    rgba(129, 140, 248, 0.12);
      --accent-glow:     rgba(129, 140, 248, 0.2);
      --today-col:       rgba(129, 140, 248, 0.08);
      --today-border:    rgba(129, 140, 248, 0.3);
      --busy-bg:         linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
      --busy-border:     #dc2626;
      --busy-text:       #fecaca;
      --free-bg:         #1e1e32;
      --free-border:     rgba(255, 255, 255, 0.12);
      --grid-line:       rgba(255, 255, 255, 0.06);
      --shadow-sm:       0 1px 2px rgba(0,0,0,0.2), 0 4px 12px rgba(0,0,0,0.15);
      --shadow-md:       0 4px 6px rgba(0,0,0,0.2), 0 10px 40px rgba(0,0,0,0.25);
    }

    [data-theme="light"] {
      --bg:              #f8f9fa;
      --bg-secondary:    #ffffff;
      --card:            #ffffff;
      --text-primary:    #1a1a2e;
      --text-secondary:  #64748b;
      --text-tertiary:   #94a3b8;
      --accent:          #6366f1;
      --accent-light:    rgba(99, 102, 241, 0.08);
      --accent-glow:     rgba(99, 102, 241, 0.15);
      --today-col:       rgba(99, 102, 241, 0.04);
      --today-border:    rgba(99, 102, 241, 0.2);
      --busy-bg:         linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
      --busy-border:     #f87171;
      --busy-text:       #991b1b;
      --free-bg:         #ffffff;
      --free-border:     #e2e8f0;
      --grid-line:       rgba(0, 0, 0, 0.06);
      --shadow-sm:       0 1px 2px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.03);
      --shadow-md:       0 4px 6px rgba(0,0,0,0.04), 0 10px 40px rgba(0,0,0,0.06);
    }

    /* ── Reset ─────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter',
                   'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background var(--transition), color var(--transition);
    }

    /* ── Header ────────────────────────────────────── */
    header {
      position: sticky;
      top: 0;
      z-index: 200;
      background: var(--bg-secondary);
      backdrop-filter: saturate(180%) blur(20px);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      border-bottom: 1px solid var(--grid-line);
      padding: 20px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background var(--transition);
    }

    .header-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.03em;
      color: var(--text-primary);
      line-height: 1.2;
    }

    header p {
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-weight: 450;
    }

    .theme-toggle {
      background: var(--card);
      border: 1px solid var(--grid-line);
      border-radius: 999px;
      width: 44px;
      height: 44px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition);
      color: var(--text-primary);
    }
    .theme-toggle:hover {
      background: var(--accent);
      color: white;
      box-shadow: var(--shadow-glow);
    }
    .theme-toggle svg {
      width: 18px;
      height: 18px;
      display: none;
    }
    [data-theme="light"] .theme-toggle .icon-sun { display: block; }
    [data-theme="dark"] .theme-toggle .icon-moon { display: block; }

    /* ── Page layout ───────────────────────────────── */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 24px 80px;
    }

    /* ── Setup notice ──────────────────────────────── */
    .notice {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.12) 0%, rgba(245, 158, 11, 0.08) 100%);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: var(--radius-lg);
      padding: 16px 20px;
      margin-bottom: 24px;
      font-size: 0.875rem;
      color: var(--text-primary);
      line-height: 1.6;
    }
    .notice-icon { font-size: 1.125rem; flex-shrink: 0; margin-top: 1px; }
    .notice strong { font-weight: 600; display: block; margin-bottom: 4px; }

    /* ── Timezone selector ────────────────────────── */
    .week-group {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
    .tz-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-start;
      width: 100%;
    }
    .tz-label {
      font-size: 0.65rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-tertiary);
      font-weight: 600;
    }
    .tz-dropdown {
      position: relative;
      width: 100%;
    }
    .tz-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--card);
      color: var(--text-primary);
      border: 1px solid var(--grid-line);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all var(--transition);
      width: 100%;
      justify-content: space-between;
    }
    .tz-button .tz-current {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 220px;
      display: inline-block;
    }
    .tz-button:hover {
      border-color: var(--accent);
      box-shadow: var(--shadow-glow);
    }
    .tz-button .tz-icon {
      width: 16px;
      height: 16px;
      display: inline-block;
    }
    .tz-button .tz-caret {
      font-size: 0.8rem;
      color: var(--text-tertiary);
    }
    .tz-menu {
      position: absolute;
      left: 0;
      top: calc(100% + 8px);
      width: min(360px, 80vw);
      max-height: 320px;
      overflow: auto;
      background: var(--card);
      border: 1px solid var(--grid-line);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      padding: 6px;
      display: none;
      z-index: 20;
    }
    .tz-menu.open { display: block; }
    .tz-option {
      width: 100%;
      text-align: left;
      background: transparent;
      border: none;
      padding: 8px 10px;
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      color: var(--text-primary);
      cursor: pointer;
    }
    .tz-option:hover,
    .tz-option.active {
      background: var(--accent-light);
      color: var(--accent);
    }

    /* ── Controls bar ──────────────────────────────── */
    .controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 16px;
    }

    /* Week navigation */
    .week-nav {
      display: flex;
      align-items: center;
      gap: 4px;
      background: var(--card);
      border-radius: 980px;
      box-shadow: var(--shadow-sm);
      padding: 6px;
      border: 1px solid var(--grid-line);
      width: 280px;
      max-width: 100%;
      justify-content: space-between;
    }

    .week-nav button {
      background: transparent;
      border: none;
      border-radius: 980px;
      width: 36px;
      height: 36px;
      cursor: pointer;
      font-size: 1.125rem;
      color: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition);
      flex-shrink: 0;
    }
    .week-nav button:hover {
      background: var(--accent-light);
      transform: scale(1.05);
    }
    .week-nav button:active {
      transform: scale(0.95);
    }
    .week-nav button:disabled {
      opacity: 0.45;
      cursor: default;
      transform: none;
      background: transparent;
    }

    .week-label {
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: -0.01em;
      color: var(--text-primary);
      min-width: 160px;
      text-align: left;
      padding: 0 6px;
      flex: 1;
    }

    /* Legend */
    .legend {
      display: flex;
      gap: 20px;
      align-items: center;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-secondary);
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .legend-dot {
      width: 14px;
      height: 14px;
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-sm);
    }
    .legend-dot.free {
      background: var(--free-bg);
      border: 1.5px solid var(--free-border);
    }
    .legend-dot.busy {
      background: var(--busy-bg);
      border: 1.5px solid var(--busy-border);
    }

    /* ── Calendar card ─────────────────────────────── */
    .cal-card {
      background: var(--card);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      border: 1px solid var(--grid-line);
      transition: background var(--transition), border var(--transition);
    }

    /* Day header row */
    .cal-header {
      display: grid;
      grid-template-columns: 52px repeat(7, 1fr);
      border-bottom: 1px solid var(--grid-line);
      background: var(--bg-secondary);
    }

    .col-time-hdr { /* spacer */ }

    .day-hdr {
      padding: 14px 6px 12px;
      text-align: center;
      border-left: 1px solid var(--grid-line);
      transition: background var(--transition);
    }
    .day-hdr.today {
      background: var(--today-col);
      position: relative;
    }
    .day-hdr.today::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent);
    }

    .day-hdr .dow {
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-tertiary);
      margin-bottom: 4px;
    }
    .day-hdr.today .dow { color: var(--accent); }

    .day-hdr .dom {
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text-primary);
      width: 34px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      border-radius: 50%;
      transition: all var(--transition);
    }
    .day-hdr.today .dom {
      background: var(--accent);
      color: white;
      box-shadow: var(--shadow-glow);
    }

    /* Body grid */
    .cal-body {
      display: grid;
      grid-template-columns: 52px repeat(7, 1fr);
    }

    .col-time { /* time labels */ }

    .time-tick {
      height: 48px;
      display: flex;
      align-items: flex-start;
      justify-content: flex-end;
      padding: 6px 10px 0 0;
      font-size: 0.65rem;
      font-weight: 500;
      letter-spacing: 0.02em;
      color: var(--text-tertiary);
      border-top: 1px solid var(--grid-line);
    }
    .time-tick:first-child { border-top: none; }

    .day-col {
      position: relative;
      border-left: 1px solid var(--grid-line);
    }
    .day-col.today-col {
      background: var(--today-col);
    }

    .bg-slot {
      height: 48px;
      border-top: 1px solid var(--grid-line);
    }
    .bg-slot:first-child { border-top: none; }

    /* Event blocks */
    .event-block {
      position: absolute;
      left: 4px;
      right: 4px;
      background: var(--busy-bg);
      border-left: 3px solid var(--busy-border);
      border-radius: var(--radius-sm);
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--busy-text);
      padding: 4px 8px 2px;
      overflow: visible;
      z-index: 1;
      box-shadow: var(--shadow-sm);
      transition: transform var(--transition), box-shadow var(--transition);
      min-height: 14px;
      line-height: 1.2;
    }
    .event-label {
      display: block;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .event-block:hover {
      box-shadow: var(--shadow-md);
      z-index: 10;
    }
    .event-block[data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      left: 50%;
      bottom: calc(100% + 6px);
      transform: translateX(-50%);
      background: var(--text-primary);
      color: var(--bg-secondary);
      font-size: 0.7rem;
      font-weight: 600;
      padding: 6px 8px;
      border-radius: 8px;
      white-space: nowrap;
      box-shadow: var(--shadow-md);
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transition);
    }
    .event-block[data-tooltip]::before {
      content: '';
      position: absolute;
      left: 50%;
      bottom: calc(100% + 2px);
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: var(--text-primary);
      opacity: 0;
      transition: opacity var(--transition);
    }
    .event-block:hover::after,
    .event-block:hover::before {
      opacity: 1;
    }

    /* Footer */
    .cal-footer {
      padding: 14px 20px;
      font-size: 0.75rem;
      color: var(--text-tertiary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      border-top: 1px solid var(--grid-line);
      background: transparent;
    }

    /* State messages */
    .state-msg {
      padding: 80px 32px;
      text-align: center;
      color: var(--text-tertiary);
      font-size: 0.95rem;
    }

    /* ── Responsive ────────────────────────────────── */
    @media (max-width: 768px) {
      header {
        padding: 16px 20px;
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
      }
      .theme-toggle {
        position: absolute;
        top: 16px;
        right: 20px;
      }
      header h1 { font-size: 1.25rem; }
      .container { padding: 20px 16px 60px; }
      .cal-header, .cal-body { grid-template-columns: 40px repeat(7, 1fr); }
      .time-tick { padding-right: 6px; font-size: 0.55rem; }
      .day-hdr { padding: 10px 4px; }
      .day-hdr .dow { font-size: 0.6rem; }
      .day-hdr .dom { font-size: 0.95rem; width: 28px; height: 28px; }
      .week-label { font-size: 0.85rem; min-width: 160px; }
      .legend { gap: 12px; font-size: 0.75rem; }
      .event-block { left: 2px; right: 2px; font-size: 0.6rem; padding: 2px 4px; }
    }

    @media (max-width: 480px) {
      .cal-header, .cal-body { grid-template-columns: repeat(7, 1fr); }
      .col-time-hdr, .col-time { display: none; }
      .week-group { align-items: flex-start; }
      .tz-row { width: 100%; justify-content: flex-start; }
      .tz-button { width: 100%; justify-content: space-between; }
      .tz-menu { right: auto; width: min(360px, 90vw); }
      .controls { flex-direction: column; align-items: stretch; }
      .week-nav { justify-content: center; }
    }
  </style>
</head>
<body>

<header>
  <div class="header-left">
    <h1 id="page-title">Availability</h1>
    <p id="page-subtitle">Loading...</p>
  </div>
  <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme" title="Toggle dark/light mode">
    <svg class="icon-sun" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <circle cx="12" cy="12" r="4" fill="none" stroke="currentColor" stroke-width="1.6"/>
      <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"
            fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
    </svg>
    <svg class="icon-moon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
            fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>
</header>

<div class="container">

  <div id="setup-notice" class="notice" style="display:none">
    <span class="notice-icon">⚙️</span>
    <div>
      <strong>Setup not yet complete</strong>
      No calendar connected. Add your ICS URL(s) as a GitHub Secret named <code>ICS_URLS</code>,
      then run the "Update Schedule" GitHub Action.
    </div>
  </div>

  <div class="controls">
    <div class="week-group">
      <div class="week-nav" id="week-nav">
        <button id="prev-week" onclick="changeWeek(-1)" aria-label="Previous week">‹</button>
        <span class="week-label" id="week-label"></span>
        <button id="next-week" onclick="changeWeek(1)" aria-label="Next week">›</button>
      </div>
      <div class="tz-row" id="tz-row">
        <div class="tz-dropdown">
          <button id="tz-button" class="tz-button" aria-haspopup="listbox" aria-expanded="false">
            <svg class="tz-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="1.6"/>
              <path d="M3 12h18M12 3a15 15 0 0 0 0 18M12 3a15 15 0 0 1 0 18"
                    fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
            </svg>
            <span id="tz-current" class="tz-current">(UTC+00:00) Dublin, Edinburgh, Lisbon, London</span>
            <span class="tz-caret">▾</span>
          </button>
          <div id="tz-menu" class="tz-menu" role="listbox" aria-label="Select time zone"></div>
        </div>
      </div>
    </div>
    <div class="legend">
      <div class="legend-item"><div class="legend-dot free"></div>Available</div>
      <div class="legend-item"><div class="legend-dot busy"></div>Busy</div>
    </div>
  </div>

  <div class="cal-card" id="cal-card">
    <div class="state-msg">Loading schedule...</div>
  </div>

  <div class="cal-footer" id="cal-footer" style="display:none">
    <span id="last-updated-label"></span>
  </div>

</div>

<script>
/* ─── Theme Toggle ──────────────────────────────────── */
function getPreferredTheme() {
  const stored = localStorage.getItem('theme');
  if (stored) return stored;
  return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
}

function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('theme', theme);
}

function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme') || getPreferredTheme();
  setTheme(current === 'dark' ? 'light' : 'dark');
}

// Initialize theme
setTheme(getPreferredTheme());

/* ─── Constants ─────────────────────────────────────── */
const DOW  = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const MONS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const PX_PER_HOUR = 48;
const GRID_PADDING = 10;
const MIN_WEEK_OFFSET = 0;
const MAX_WEEK_OFFSET = 4;

/* ─── State ─────────────────────────────────────────── */
let data          = null;
let weekOffset    = 0;
let workStart     = 8;
let workEnd       = 19;
let displayTz     = 'Europe/London';
let tzLoaded      = false;
let tzMenuOptions = [];
let tzByOffset    = new Map();

/* ─── Helpers ───────────────────────────────────────── */
const WEEKDAY_INDEX = { Sun: 0, Mon: 1, Tue: 2, Wed: 3, Thu: 4, Fri: 5, Sat: 6 };

function getZonedParts(date, timeZone) {
  const parts = new Intl.DateTimeFormat('en-GB', {
    timeZone,
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    weekday: 'short',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  }).formatToParts(date);

  const map = {};
  for (const p of parts) {
    if (p.type !== 'literal') map[p.type] = p.value;
  }

  let hour = Number(map.hour);
  if (hour === 24) hour = 0;

  return {
    year: Number(map.year),
    month: Number(map.month),
    day: Number(map.day),
    hour,
    minute: Number(map.minute),
    second: Number(map.second),
    weekday: map.weekday
  };
}

function getTimeZoneOffsetMs(date, timeZone) {
  const parts = getZonedParts(date, timeZone);
  const asUTC = Date.UTC(parts.year, parts.month - 1, parts.day, parts.hour, parts.minute, parts.second);
  return asUTC - date.getTime();
}

function zonedTimeToDate(y, m, d, h, min, s, timeZone) {
  let date = new Date(Date.UTC(y, m - 1, d, h, min, s));
  let offset = getTimeZoneOffsetMs(date, timeZone);
  date = new Date(date.getTime() - offset);
  const offset2 = getTimeZoneOffsetMs(date, timeZone);
  if (offset !== offset2) {
    date = new Date(date.getTime() - offset2);
  }
  return date;
}

function addDaysToParts(parts, delta) {
  const d = new Date(Date.UTC(parts.year, parts.month - 1, parts.day));
  d.setUTCDate(d.getUTCDate() + delta);
  return { year: d.getUTCFullYear(), month: d.getUTCMonth() + 1, day: d.getUTCDate() };
}

function getWeekStartParts(timeZone, offsetWeeks) {
  const nowParts = getZonedParts(new Date(), timeZone);
  const weekdayIndex = WEEKDAY_INDEX[nowParts.weekday] ?? 1;
  const daysFromMonday = (weekdayIndex + 6) % 7;
  let monday = addDaysToParts(nowParts, -daysFromMonday);
  monday = addDaysToParts(monday, offsetWeeks * 7);
  return monday;
}

function fmtParts(parts) {
  return `${parts.day} ${MONS[parts.month - 1]}`;
}

function fmtWeekday(parts) {
  const d = zonedTimeToDate(parts.year, parts.month, parts.day, 12, 0, 0, displayTz);
  return new Intl.DateTimeFormat('en-GB', { weekday: 'short', timeZone: displayTz }).format(d);
}

function isTodayParts(parts) {
  const today = getZonedParts(new Date(), displayTz);
  return parts.year === today.year && parts.month === today.month && parts.day === today.day;
}

function fmtTime(hour) {
  if (hour === 0)  return '12am';
  if (hour === 12) return '12pm';
  return hour < 12 ? `${hour}am` : `${hour - 12}pm`;
}

function getTimeZoneLabel(date, timeZone) {
  try {
    const parts = new Intl.DateTimeFormat('en-GB', {
      timeZone,
      timeZoneName: 'short'
    }).formatToParts(date);
    const tz = parts.find(p => p.type === 'timeZoneName');
    return tz ? tz.value : timeZone;
  } catch {
    return timeZone;
  }
}

const TIME_ZONES = [
  { tz: 'Etc/GMT+12', name: 'International Date Line West' },
  { tz: 'Pacific/Pago_Pago', name: 'Samoa' },
  { tz: 'Pacific/Honolulu', name: 'Hawaii' },
  { tz: 'Pacific/Marquesas', name: 'Marquesas Islands' },
  { tz: 'America/Anchorage', name: 'Alaska' },
  { tz: 'America/Los_Angeles', name: 'Pacific Time (US & Canada)' },
  { tz: 'America/Denver', name: 'Mountain Time (US & Canada)' },
  { tz: 'America/Chicago', name: 'Central Time (US & Canada)' },
  { tz: 'America/New_York', name: 'Eastern Time (US & Canada)' },
  { tz: 'America/Halifax', name: 'Atlantic Time (Canada)' },
  { tz: 'America/St_Johns', name: 'Newfoundland' },
  { tz: 'America/Argentina/Buenos_Aires', name: 'Buenos Aires' },
  { tz: 'America/Noronha', name: 'Mid-Atlantic' },
  { tz: 'Atlantic/Azores', name: 'Azores' },
  { tz: 'Europe/London', name: 'Dublin, Edinburgh, Lisbon, London' },
  { tz: 'Europe/Paris', name: 'Brussels, Copenhagen, Madrid, Paris' },
  { tz: 'Europe/Athens', name: 'Athens, Bucharest' },
  { tz: 'Europe/Moscow', name: 'Moscow, St. Petersburg' },
  { tz: 'Asia/Tehran', name: 'Tehran' },
  { tz: 'Asia/Dubai', name: 'Abu Dhabi, Muscat' },
  { tz: 'Asia/Kabul', name: 'Kabul' },
  { tz: 'Asia/Karachi', name: 'Islamabad, Karachi' },
  { tz: 'Asia/Kolkata', name: 'Chennai, Kolkata, Mumbai, New Delhi' },
  { tz: 'Asia/Kathmandu', name: 'Kathmandu' },
  { tz: 'Asia/Dhaka', name: 'Astana, Dhaka' },
  { tz: 'Asia/Yangon', name: 'Yangon (Rangoon)' },
  { tz: 'Asia/Bangkok', name: 'Bangkok, Hanoi, Jakarta' },
  { tz: 'Asia/Shanghai', name: 'Beijing, Chongqing, Hong Kong' },
  { tz: 'Australia/Eucla', name: 'Eucla' },
  { tz: 'Asia/Tokyo', name: 'Osaka, Sapporo, Tokyo' },
  { tz: 'Australia/Darwin', name: 'Darwin' },
  { tz: 'Australia/Brisbane', name: 'Brisbane' },
  { tz: 'Australia/Adelaide', name: 'Adelaide' },
  { tz: 'Pacific/Noumea', name: 'Solomon Is., New Caledonia' },
  { tz: 'Asia/Kamchatka', name: 'Fiji, Kamchatka, Marshall Is.' },
  { tz: 'Pacific/Chatham', name: 'Chatham Islands' },
  { tz: 'Pacific/Tongatapu', name: 'Nuku\'alofa' },
  { tz: 'Pacific/Kiritimati', name: 'Kiritimati Island' }
];

function formatOffsetLabel(ms) {
  const totalMins = Math.round(ms / 60000);
  const sign = totalMins >= 0 ? '+' : '-';
  const abs = Math.abs(totalMins);
  const h = String(Math.floor(abs / 60)).padStart(2, '0');
  const m = String(abs % 60).padStart(2, '0');
  return `UTC${sign}${h}:${m}`;
}

function getOffsetKey(tz) {
  return formatOffsetLabel(getTimeZoneOffsetMs(new Date(), tz));
}

function buildTimeZoneLabel(tz, name) {
  const offset = getTimeZoneOffsetMs(new Date(), tz);
  return `(${formatOffsetLabel(offset)}) ${name}`;
}

function escapeAttr(value) {
  return value
    .replaceAll('&', '&amp;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;');
}

function formatTime12(date, timeZone) {
  const parts = new Intl.DateTimeFormat('en-US', {
    timeZone,
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
  }).formatToParts(date);
  const hour = parts.find(p => p.type === 'hour')?.value || '';
  const minute = parts.find(p => p.type === 'minute')?.value || '00';
  const period = parts.find(p => p.type === 'dayPeriod')?.value?.toLowerCase() || '';
  const mins = minute === '00' ? '' : `:${minute}`;
  return `${hour}${mins}${period}`;
}

function formatEventRange(start, end, timeZone) {
  const dateFmt = new Intl.DateTimeFormat('en-GB', { timeZone, dateStyle: 'medium' });
  const dateStart = dateFmt.format(start);
  const dateEnd = dateFmt.format(end);
  const timeStart = formatTime12(start, timeZone);
  const timeEnd = formatTime12(end, timeZone);
  if (dateStart === dateEnd) {
    return `${dateStart}, ${timeStart}–${timeEnd}`;
  }
  return `${dateStart} ${timeStart} – ${dateEnd} ${timeEnd}`;
}

function initTimezoneDropdown() {
  if (tzLoaded) return;
  const btn = document.getElementById('tz-button');
  const menu = document.getElementById('tz-menu');
  if (!btn || !menu) return;

  tzMenuOptions = [];
  tzByOffset = new Map();
  for (const z of TIME_ZONES) {
    const key = getOffsetKey(z.tz);
    if (tzByOffset.has(key)) continue;
    tzByOffset.set(key, z);
    tzMenuOptions.push({ ...z, offsetKey: key });
  }
  tzMenuOptions.sort((a, b) => {
    const oa = getTimeZoneOffsetMs(new Date(), a.tz);
    const ob = getTimeZoneOffsetMs(new Date(), b.tz);
    if (oa !== ob) return oa - ob;
    return a.name.localeCompare(b.name);
  });

  for (const z of tzMenuOptions) {
    const opt = document.createElement('button');
    opt.className = 'tz-option';
    opt.type = 'button';
    opt.dataset.tz = z.tz;
    opt.textContent = buildTimeZoneLabel(z.tz, z.name);
    opt.addEventListener('click', () => {
      setDisplayTimezone(z.tz);
      closeTimezoneMenu();
    });
    menu.appendChild(opt);
  }

  btn.addEventListener('click', () => {
    const isOpen = menu.classList.contains('open');
    if (isOpen) {
      closeTimezoneMenu();
    } else {
      openTimezoneMenu();
    }
  });

  document.addEventListener('click', (e) => {
    if (!menu.contains(e.target) && !btn.contains(e.target)) {
      closeTimezoneMenu();
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeTimezoneMenu();
  });

  window.addEventListener('resize', syncWeekWidth);

  tzLoaded = true;
}

function openTimezoneMenu() {
  const btn = document.getElementById('tz-button');
  const menu = document.getElementById('tz-menu');
  if (!btn || !menu) return;
  menu.classList.add('open');
  btn.setAttribute('aria-expanded', 'true');
}

function closeTimezoneMenu() {
  const btn = document.getElementById('tz-button');
  const menu = document.getElementById('tz-menu');
  if (!btn || !menu) return;
  menu.classList.remove('open');
  btn.setAttribute('aria-expanded', 'false');
}

function syncWeekWidth() {
  const weekNav = document.getElementById('week-nav');
  const tzRow = document.getElementById('tz-row');
  const tzMenu = document.getElementById('tz-menu');
  if (!weekNav || !tzRow) return;
  const width = weekNav.offsetWidth;
  if (width > 0) {
    tzRow.style.width = `${width}px`;
    if (tzMenu) tzMenu.style.width = `${width}px`;
  }
}

function setDisplayTimezone(tz, opts = { render: true }) {
  const available = TIME_ZONES.some(z => z.tz === tz);
  displayTz = available ? tz : TIME_ZONES[0].tz;
  localStorage.setItem('displayTz', displayTz);

  const current = document.getElementById('tz-current');
  if (current) {
    const offsetKey = getOffsetKey(displayTz);
    const zone = tzByOffset.get(offsetKey) || tzMenuOptions[0] || TIME_ZONES[0];
    current.textContent = buildTimeZoneLabel(zone.tz, zone.name);
  }

  const menu = document.getElementById('tz-menu');
  if (menu) {
    const offsetKey = getOffsetKey(displayTz);
    menu.querySelectorAll('.tz-option').forEach((btn) => {
      const key = getOffsetKey(btn.dataset.tz);
      btn.classList.toggle('active', key === offsetKey);
    });
  }

  if (opts.render) renderWeek();
}

/* ─── Render ────────────────────────────────────────── */
function renderWeek() {
  if (!data) return;

  const weekStartParts = getWeekStartParts(displayTz, weekOffset);
  const weekEndParts = addDaysToParts(weekStartParts, 7);
  const weekStart = zonedTimeToDate(weekStartParts.year, weekStartParts.month, weekStartParts.day, 0, 0, 0, displayTz);
  const weekEnd = zonedTimeToDate(weekEndParts.year, weekEndParts.month, weekEndParts.day, 0, 0, 0, displayTz);

  // Week label
  const labelEndParts = addDaysToParts(weekStartParts, 6);
  document.getElementById('week-label').textContent =
    `${fmtParts(weekStartParts)} – ${fmtParts(labelEndParts)} ${labelEndParts.year}`;
  const prevBtn = document.getElementById('prev-week');
  const nextBtn = document.getElementById('next-week');
  if (prevBtn) prevBtn.disabled = weekOffset <= MIN_WEEK_OFFSET;
  if (nextBtn) nextBtn.disabled = weekOffset >= MAX_WEEK_OFFSET;
  syncWeekWidth();

  // Build days array (Mon → Sun)
  const days = [];
  for (let i = 0; i < 7; i++) {
    days.push(addDaysToParts(weekStartParts, i));
  }

  // Filter events to this week
  const weekEvents = (data.events || []).filter(e => {
    const s = new Date(e.start), en = new Date(e.end);
    return s < weekEnd && en > weekStart;
  });

  const hourCount = workEnd - workStart;
  const bodyH     = (hourCount * PX_PER_HOUR) + (GRID_PADDING * 2);

  let h = '';

  /* Header row */
  h += '<div class="cal-header">';
  h += '<div class="col-time-hdr"></div>';
  for (const d of days) {
    const cls = isTodayParts(d) ? 'day-hdr today' : 'day-hdr';
    h += `<div class="${cls}">
      <div class="dow">${fmtWeekday(d)}</div>
      <div class="dom">${d.day}</div>
    </div>`;
  }
  h += '</div>';

  /* Body */
  h += '<div class="cal-body">';

  /* Time column */
  h += `<div class="col-time" style="padding:${GRID_PADDING}px 0">`;
  for (let hr = workStart; hr < workEnd; hr++) {
    h += `<div class="time-tick">${fmtTime(hr)}</div>`;
  }
  h += '</div>';

  /* Day columns */
  for (const d of days) {
    const dayStart = zonedTimeToDate(d.year, d.month, d.day, workStart, 0, 0, displayTz);
    const dayEnd   = zonedTimeToDate(d.year, d.month, d.day, workEnd,   0, 0, displayTz);

    const todayCls = isTodayParts(d) ? ' today-col' : '';
    h += `<div class="day-col${todayCls}" style="height:${bodyH}px;padding:${GRID_PADDING}px 0">`;

    /* Background slots */
    for (let i = 0; i < hourCount; i++) {
      h += '<div class="bg-slot"></div>';
    }

    /* Events */
    const dayEvts = weekEvents.filter(e => {
      const s = new Date(e.start), en = new Date(e.end);
      return s < dayEnd && en > dayStart;
    });

    for (const ev of dayEvts) {
      const s  = new Date(ev.start);
      const en = new Date(ev.end);
      const cs = s  < dayStart ? dayStart : s;
      const ce = en > dayEnd   ? dayEnd   : en;
      const startMins = (cs - dayStart) / 60000;
      const durMins   = (ce - cs) / 60000;
      if (durMins <= 0) continue;

      const top    = GRID_PADDING + (startMins / 60) * PX_PER_HOUR;
      const height = Math.max((durMins / 60) * PX_PER_HOUR, 14);
      const tooltip = escapeAttr(formatEventRange(s, en, displayTz));

      h += `<div class="event-block" style="top:${top}px;height:${height}px" data-tooltip="${tooltip}" aria-label="${tooltip}"><span class="event-label">Busy</span></div>`;
    }

    h += '</div>';
  }

  h += '</div>';

  document.getElementById('cal-card').innerHTML = h;

  /* Footer */
  const footer = document.getElementById('cal-footer');
  footer.style.display = 'flex';
  const updatedAt = data.lastUpdated ? new Date(data.lastUpdated) : null;
  const tzLabel = formatOffsetLabel(getTimeZoneOffsetMs(updatedAt || new Date(), displayTz));
  const dateStr = updatedAt
    ? new Intl.DateTimeFormat('en-GB', { timeZone: displayTz, dateStyle: 'medium' }).format(updatedAt)
    : '';
  const timeStr = updatedAt
    ? new Intl.DateTimeFormat('en-GB', { timeZone: displayTz, timeStyle: 'short' }).format(updatedAt)
    : '';
  const lu = updatedAt ? `Last updated ${dateStr} at ${timeStr} ${tzLabel}` : '';
  document.getElementById('last-updated-label').textContent = lu;
}

function changeWeek(dir) {
  weekOffset = Math.max(MIN_WEEK_OFFSET, Math.min(weekOffset + dir, MAX_WEEK_OFFSET));
  renderWeek();
}

async function loadSchedule() {
  const res = await fetch(`schedule.json?_=${Date.now()}`, { cache: 'no-store' });
  if (!res.ok) throw new Error('HTTP ' + res.status);
  data = await res.json();

  workStart = data.workdayStart ?? 8;
  workEnd   = data.workdayEnd   ?? 19;

  const name  = data.ownerName           || 'Schedule';
  const hours = data.weeklyProjectHours  || 20;

  document.getElementById('page-title').textContent    = `${name}'s Availability`;
  document.getElementById('page-subtitle').textContent =
    `${hours} hours/week available for the Dashboard project`;
  document.title = `${name}'s Availability`;

  const notice = document.getElementById('setup-notice');
  notice.style.display = data.configured ? 'none' : 'flex';

  initTimezoneDropdown();
  const storedTz = localStorage.getItem('displayTz');
  const defaultTz = storedTz || data.displayTimezone || TIME_ZONES[0].tz;
  setDisplayTimezone(defaultTz, { render: false });

  renderWeek();
}

/* ─── Boot ──────────────────────────────────────────── */
async function init() {
  try {
    await loadSchedule();
  } catch (err) {
    document.getElementById('cal-card').innerHTML =
      '<div class="state-msg">Could not load schedule.json — please check the setup.</div>';
    console.error(err);
  }
}

init();
</script>
</body>
</html>
